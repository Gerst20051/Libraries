/*
 * Crafty v0.1
 * http://craftyjs.com
 *
 * Copyright 2010, Louis Stowasser
 * Dual licensed under the MIT or GPL licenses.
 */
(function(i,e){var k=function(q){return new k.fn.init(q)},h=1,m=50,c=1,f={},g={},d={},o=[],b,n=Array.prototype.slice,j=/\s*,\s*/,p=/\s+/;k.fn=k.prototype={init:function(u){if(typeof u==="string"){var s=0,y,x=false,v=false,z;if(u==="*"){for(y in g){this[+y]=g[y];s++}this.length=s;return this}if(u.indexOf(",")!==-1){v=true;z=j}else{if(u.indexOf(" ")!==-1){x=true;z=p}}for(y in g){if(!g.hasOwnProperty(y)){continue}if(x||v){var q=u.split(z),w=0,t=q.length,r=0;for(;w<t;w++){if(k(+y).has(q[w])){r++}}if(x&&r===t||v&&r>0){this[s++]=+y}}else{if(k(+y).has(u)){this[s++]=+y}}}if(s>0&&!x&&!v){this.extend(f[u])}if(q&&x){for(w=0;w<t;w++){this.extend(f[q[w]])}}this.length=s}else{if(!u){u=0;if(!(u in g)){g[u]=this}}if(!(u in g)){this.length=0;return this}this[0]=u;this.length=1;if(!this.__c){this.__c={}}if(!g[u]){g[u]=this}return g[u]}return this},addComponent:function(w){var t=[],v=0,s;if(arguments.length>1){var r=0,q=arguments.length;for(;r<q;r++){this.__c[arguments[r]]=true;t.push(arguments[r])}}else{if(w.indexOf(",")!==-1){var u=w.split(j),r=0,q=u.length;for(;r<q;r++){this.__c[u[r]]=true;t.push(u[r])}}else{this.__c[w]=true;t.push(w)}}s=t.length;for(;v<s;v++){comp=f[t[v]];this.extend(comp);if(comp&&"init" in comp){comp.init.call(this)}}return this},removeComponent:function(q){delete this.__c[q];return this},has:function(q){return !!this.__c[q]},attr:function(q,r){if(arguments.length===1){if(typeof q==="string"){return this[q]}this.extend(q);this.trigger("change");return this}this[q]=r;this.trigger("change");return this},toArray:function(){return n.call(this,0)},delay:function(q,r){this.each(function(){var s=this;setTimeout(function(){q.call(s)},r)})},bind:function(r,q){this.each(function(){if(!d[r]){d[r]={}}var s=d[r];if(!s[this[0]]){s[this[0]]=[]}s[this[0]].push(q)});return this},unbind:function(r,q){this.each(function(){var u=d[r],t=0,s,v;if(u[this[0]]){s=u[this[0]].length}else{return this}if(s===1||!q){delete u[this[0]];return this}for(;t<s;t++){v=u[this[0]];if(v[t]==q){v.splice(t,1);t--}}});return this},trigger:function(q,r){this.each(function(){if(d[q]&&d[q][this[0]]){var u=d[q][this[0]],t=0,s=u.length;for(;t<s;t++){u[t].call(this,r)}}});return this},each:function(s){var r=0,q=this.length;for(;r<q;r++){s.call(k(this[r]),r)}return this},destroy:function(){this.each(function(){this.trigger("remove");for(var q in d){this.unbind(q)}delete g[this[0]]})}};k.fn.init.prototype=k.fn;k.extend=k.fn.extend=function(r){var q=this;if(!r){return q}for(key in r){if(q===r[key]){continue}q[key]=r[key]}return q};k.extend({init:function(s,q,r){if(s){m=s}k.viewport.init(q,r);this.onload();b=setInterval(function(){k.trigger("enterframe",{frame:c++})},1000/m)},stop:function(){clearInterval(b)},e:function(){var r=a(),q;g[r]=null;g[r]=q=k(r);if(arguments.length>0){q.addComponent.apply(q,arguments)}q.addComponent("obj");return q},c:function(r,q){f[r]=q},trigger:function(u,v){var t=d[u],s,r,q;for(s in t){if(!t.hasOwnProperty(s)){continue}q=t[s].length;for(r=0;r<q;r++){if(t[s]&&t[s][r]){t[s][r].call(k(+s),v)}}}},frame:function(){return c},onload:function(r,t){if(!arguments.length){var s=0,q=o.length,u;for(;s<q;++s){u=o[s];if(u){u.fn.call(u.ctx)}}return this}o.push({ctx:r,fn:t});return this}});function a(){var q=h++;if(q in g){return a()}return q}i.Crafty=k})(window);(function(d,c,a){(function(k){var j,n=function(p){j=p||64;this.map={}},o=Math,e=o.floor,m=" ";n.prototype={insert:function(u){var s=n.key(u),r=new i(s,u,this),q=0,p,t;for(q=s.x1;q<=s.x2;q++){for(p=s.y1;p<=s.y2;p++){t=q+m+p;if(!this.map[t]){this.map[t]=[]}this.map[t].push(u)}}return r},search:function(x,q){var y=n.key(x),w,s,u,v,p,t=[],r=[],z={};if(q===undefined){q=true}for(w=y.x1;w<=y.x2;w++){for(s=y.y1;s<=y.y2;s++){u=w+m+s;if(this.map[u]){t=t.concat(this.map[u])}}}if(q){for(w=0,l=t.length;w<l;w++){v=t[w];if(!v){continue}p=v[0];if(!z[p]&&v.x<x.x+x.w&&v.x+v.w>x.x&&v.y<x.y+x.h&&v.h+v.y>x.y){z[p]=t[w]}}for(v in z){r.push(z[v])}return r}else{return t}},remove:function(t,v){var s=0,r,u;if(arguments.length==1){v=t;t=n.key(v)}for(s=t.x1;s<=t.x2;s++){for(r=t.y1;r<=t.y2;r++){u=s+m+r;if(this.map[u]){var q=this.map[u],p=0,w=q.length;for(;p<w;p++){if(q[p]&&q[p][0]===v[0]){q.splice(p,1)}}}}}}};n.key=function(t){var q=e(t.x/j),s=e(t.y/j),p=e((t.w+t.x)/j),r=e((t.h+t.y)/j);return{x1:q,y1:s,x2:p,y2:r}};n.hash=function(p){return p.x1+m+p.y1+m+p.x2+m+p.y2};function i(p,r,q){this.keys=p;this.map=q;this.obj=r}i.prototype={update:function(p){if(n.hash(n.key(p))!=n.hash(this.keys)){this.map.remove(this.keys,this.obj);var q=this.map.insert(this.obj);this.keys=q.keys}}};k.HashMap=n})(d);d.map=new d.HashMap();d.c("2D",{_x:0,_y:0,_w:0,_h:0,_z:0,_rotation:0,_origin:{x:0,y:0},_mbr:null,_entry:null,_attachy:[],init:function(){if(d.support.setter){this.__defineSetter__("x",function(e){this._attr("_x",e)});this.__defineSetter__("y",function(e){this._attr("_y",e)});this.__defineSetter__("w",function(e){this._attr("_w",e)});this.__defineSetter__("h",function(e){this._attr("_h",e)});this.__defineSetter__("z",function(e){this._attr("_z",e)});this.__defineSetter__("rotation",function(e){this._attr("_rotation",e)});this.__defineGetter__("x",function(){return this._x});this.__defineGetter__("y",function(){return this._y});this.__defineGetter__("w",function(){return this._w});this.__defineGetter__("h",function(){return this._h});this.__defineGetter__("z",function(){return this._z});this.__defineGetter__("rotation",function(){return this._rotation})}else{this.x=this._x;this.y=this._y;this.w=this._w;this.h=this._h;this.z=this._z;this.bind("enterframe",function(){if(this.x!==this._x||this.y!==this._y||this.w!==this._w||this.h!==this._h||this.z!==this._z){var e=this.pos();this._x=this.x;this._y=this.y;this._w=this.w;this._h=this.h;this._z=this.z;this.trigger("move",e);this.trigger("change",e)}})}this._entry=d.map.insert(this);this.bind("move",function(){this._entry.update(this)});this.bind("remove",function(){d.map.remove(this);this.detach()})},_rotate:function(t){var s=-1*(t%360),B=s*(Math.PI/180),r=Math.cos(B),w=Math.sin(B),u={x:this._origin.x+this._x,y:this._origin.y+this._y};if(!s){this._mbr=null;if(!this._rotation%360){return}}var A=u.x+(this._x-u.x)*r+(this._y-u.y)*w,m=u.y-(this._x-u.x)*w+(this._y-u.y)*r,z=u.x+(this._x+this._w-u.x)*r+(this._y-u.y)*w,j=u.y-(this._x+this._w-u.x)*w+(this._y-u.y)*r,y=u.x+(this._x+this._w-u.x)*r+(this._y+this._h-u.y)*w,i=u.y-(this._x+this._w-u.x)*w+(this._y+this._h-u.y)*r,x=u.x+(this._x-u.x)*r+(this._y+this._h-u.y)*w,e=u.y-(this._x-u.x)*w+(this._y+this._h-u.y)*r,q=Math.floor(Math.min(A,z,y,x)),n=Math.floor(Math.min(m,j,i,e)),p=Math.ceil(Math.max(A,z,y,x)),k=Math.ceil(Math.max(m,j,i,e));this._mbr={_x:q,_y:n,_w:p-q,_h:k-n}},area:function(){return this._w*this._h},intersect:function(e,m,i,j){var k;if(typeof e==="object"){k=e}else{k={x:e,y:m,w:i,h:j}}return this._x<k.x+k.w&&this._x+this._w>k.x&&this._y<k.y+k.h&&this._h+this._y>k.y},within:function(e,m,i,j){var k;if(typeof e==="object"){k=e}else{k={x:e,y:m,w:i,h:j}}return k.x>=this.x&&k.x+k.w<=this.x+this.w&&k.y>=this.y&&k.y+k.h<=this.y+this.h},pos:function(){return{_x:Math.floor(this._x),_y:Math.floor(this._y),_w:Math.floor(this._w),_h:Math.floor(this._h)}},isAt:function(e,i){return this.x<=e&&this.x+this.w>=e&&this.y<=i&&this.y+this.h>=i},move:function(e,i){if(e.charAt(0)==="n"){this.y-=i}if(e.charAt(0)==="s"){this.y+=i}if(e==="e"||e.charAt(1)==="e"){this.x+=i}if(e==="w"||e.charAt(1)==="w"){this.x-=i}return this},shift:function(e,k,i,j){if(e){this.x+=e}if(k){this.y+=k}if(i){this.w+=i}if(j){this.h+=j}return this},attach:function(e){function i(o){if(!o){return}var k=this.x-o._x,j=this.y-o._y,m=this.w-o._w,n=this.h-o._h;e.shift(k,j,m,n)}this.bind("move",i);this._attachy[e[0]]=i;return this},detach:function(k){if(!k){var i,e=this._attachy;for(i in e){if(!e.hasOwnProperty(i)){continue}this.unbind("move",e[i]);this._attachy[i]=null;delete this._attachy[i]}return this}var j=this._attachy[k[0]];this.unbind("move",j);this._attachy[k[0]]=null;delete this._attachy[k[0]];return this},origin:function(e,k){if(typeof e==="string"){if(e==="centre"||e==="center"||e.indexOf(" ")===-1){e=this._w/2;k=this._h/2}else{var i=e.split(" ");if(i[0]==="top"){k=0}else{if(i[0]==="bottom"){k=this._h}else{if(i[0]==="middle"||i[1]==="center"||i[1]==="centre"){k=this._h/2}}}if(i[1]==="center"||i[1]==="centre"||i[1]==="middle"){e=this._w/2}else{if(i[1]==="left"){e=0}else{if(i[1]==="right"){e=this._w}}}}}else{if(e>this._w||k>this._h||e<0||k<0){return}}var j=this._origin;j.x=e;j.y=k;return this},mbr:function(){var e=this._mbr;if(!e){return}return{_x:e._x,_y:e._y,_w:e._w,_h:e._h}},_attr:function(i,j){var e=this.mbr()||this.pos();if(i==="_rotation"){this._rotate(j)}else{var k=this._mbr;if(k){k[i]-=this[i]-j}}this[i]=j;this.trigger("move",e);this.trigger("change",e)}});d.c("gravity",{_gravity:0.2,_gy:0,_bounce:0.8,_friction:0.8,_falling:true,_anti:null,init:function(){if(!this.has("2D")){this.addComponent("2D")}},gravity:function(e){if(e){this._anti=e}this.bind("enterframe",this._enterframe);return this},_enterframe:function(){if(this._falling){this._gy+=this._gravity*2;this.y+=this._gy}else{this._gy=0}var i=this,e=false;d(this._anti).each(function(){if(this.intersect(i.x,i.y+1,i.w,i.h)&&i!==this){e=this}});if(e){if(this._falling){this.stopFalling(e)}}else{this._falling=true}},stopFalling:function(i){if(i){this.y=i.y-this.h}this._falling=false;if(this.__move&&this.__move.up){this.__move.up=false}this.trigger("hit");return this},antigravity:function(){this.unbind("enterframe",this._enterframe);return this}});d.c("collision",{_collided:false,collision:function(e,j,i){var m=this,k=false;this.bind("enterframe",function(){if(typeof e==="string"){k=false;d(e).each(function(){if(this.intersect(m)){m._collided=true;k=this}});if(k){j.call(this,k)}else{if(i&&this._collided){i.call(this)}}}else{if(typeof e==="object"){if(e.intersect(m)){j.call(m,e)}}}});return this}});d.polygon=function(e){if(arguments.length>1){e=Array.prototype.slice.call(arguments,0)}this.points=e};d.polygon.prototype={containsPoint:function(e,q){var n=this.points,m,k,o=false;for(m=0,k=n.length-1;m<n.length;k=m++){if(((n[m][1]>q)!=(n[k][1]>q))&&(e<(n[k][0]-n[m][0])*(q-n[m][1])/(n[k][1]-n[m][1])+n[m][0])){o=!o}}return o},shift:function(e,n){var k=0,j=this.points.length,m;for(;k<j;k++){m=this.points[k];m[0]+=e;m[1]+=n}}};d.c("DOM",{_element:null,init:function(){this._element=a.createElement("div");d.stage.elem.appendChild(this._element);this._element.style.position="absolute";this._element.id="ent"+this[0];this.bind("change",this.draw);this.bind("remove",this.undraw)},DOM:function(e){if(!this.has("2D")){this.addComponent("2D")}this._element=e;this._element.style.position="absolute";return this},draw:function(){var i=this._element.style,k;i.top=Math.floor(this._y)+"px";i.left=Math.floor(this._x)+"px";i.width=Math.floor(this._w)+"px";i.height=Math.floor(this._h)+"px";i.zIndex=this.z;if(this._mbr){var j="rotate("+this._rotation+"deg)",e=this._origin.x+"px "+this._origin.y+"px";i.transformOrigin=e;i.mozTransformOrigin=e;i.webkitTransformOrigin=e;i.oTransformOrigin=e;i.transform=j;i.mozTransform=j;i.webkitTransform=j;i.oTransform=j}this.trigger("draw",{style:i,type:"DOM"});if(this.has("sprite")){k=this.__coord;i.background="url('"+this.__image+"') no-repeat -"+k[0]+"px -"+k[1]+"px"}return this},undraw:function(){d.stage.elem.removeChild(this._element);return this},css:function(k){var e,j=this._element,i=j.style;for(e in k){if(!k.hasOwnProperty(e)){continue}i[e]=k[e]}this.trigger("change");return this}});try{a.execCommand("BackgroundImageCache",false,true)}catch(g){}d.extend({window:{init:function(){this.width=c.innerWidth||(c.document.documentElement.clientWidth||c.document.body.clientWidth);this.height=c.innerHeight||(c.document.documentElement.clientHeight||c.document.body.clientHeight)},width:0,height:0},inner:function(m){var k=m.getBoundingClientRect(),e=k.left,n=k.top,j,i;j=parseInt(this.getStyle(m,"border-left-width")||0,10);i=parseInt(this.getStyle(m,"border-top-width")||0,10);if(!j||!i){j=parseInt(this.getStyle(m,"borderLeftWidth")||0,10);i=parseInt(this.getStyle(m,"borderTopWidth")||0,10)}e+=j;n+=i;return{x:e,y:n}},getStyle:function(i,j){var e;if(i.currentStyle){e=i.currentStyle[j]}else{if(c.getComputedStyle){e=a.defaultView.getComputedStyle(i,null).getPropertyValue(j)}}return e}});d.extend({randRange:function(i,e){return Math.round(Math.random()*(e-i)+i)},sprite:function(o,i,e,k,j){var q,t,r,p,s,n,m;if(typeof o==="string"){e=i;i=o;o=1}if(!j&&k){j=k}k=parseInt(k||0,10);j=parseInt(j||0,10);m=d.assets[i];if(!m){m=new Image();m.src=i;d.assets[i]=m}for(q in e){if(!e.hasOwnProperty(q)){continue}t=e[q];r=t[0]*o+k;p=t[1]*o+j;s=t[2]*o||o;n=t[3]*o||o;d.c(q,{__image:i,__coord:[r,p,s,n],__tile:o,__padding:[k,j],img:m,init:function(){this.addComponent("sprite");if(this.has("canvas")){if(this.img.complete&&this.img.width>0){b.add(this)}else{var u=this;this.img.onload=function(){b.add(u)}}}this.w=this.__coord[2];this.h=this.__coord[3]},sprite:function(u,A,v,z){this.__coord=[u*this.__tile+this.__padding[0],A*this.__tile+this.__padding[1],v*this.__tile||this.__tile,z*this.__tile||this.__tile];if(this.has("canvas")){b.add(this)}else{if(this.has("DOM")){this.draw()}}}})}return this},_events:{},addEvent:function(e,m,k,j){if(arguments.length===3){j=k;k=m;m=c.document}var i=function(n){var n=n||c.event;j.call(e,n)};if(!this._events[m+k+j]){this._events[m+k+j]=i}else{return}if(m.attachEvent){m.attachEvent("on"+k,i)}else{m.addEventListener(k,i,false)}},removeEvent:function(e,m,k,j){if(arguments.length===3){j=k;k=m;m=c.document}var i=this._events[m+k+j];if(i){if(m.detachEvent){m.detachEvent("on"+k,i)}else{m.removeEventListener(k,i,false)}delete this._events[m+k+j]}},background:function(e){d.stage.elem.style.background=e},viewport:{width:0,height:0,_x:0,_y:0,scroll:function(r,B){var p=this[r],e,x=0,w=0,t,s,y,C={},A,z=[];if(d.context){d.context.clearRect(0,0,this.width,this.height)}A={x:r=="_x"?p:this._x,y:r=="_y"?p:this._y,w:this.width,h:this.height};e=d.map.search(A,false);for(t=e.length;x<t;++x){y=e[x];if(!C[y[0]]){C[y[0]]=true;if(!z[y._z]){z[y._z]=[]}z[y._z].push(y)}}d("2D obj").each(function(){var i=this.pos();this[r]-=p-B;if(d.support.setter===false){this[r.substr(1)]=this[r];this.trigger("change",i)}this.trigger("move",i)});s=z.length;for(;w<s;w++){if(!z[w]){continue}var u=0,o=z[w].length;for(;u<o;u++){if("draw" in z[w][u]){z[w][u].draw()}}}this[r]=B},rect:function(){return{x:this._x,y:this._y,w:this.width,h:this.height}},init:function(e,i){d.window.init();this.width=e||d.window.width;this.height=i||d.window.height;if(!e&&!i){a.body.style.overflow="hidden"}var k=a.getElementById("cr-stage");d.stage={x:0,y:0,elem:(k?k:a.createElement("div"))};if(!k){a.body.appendChild(d.stage.elem);d.stage.elem.id="cr-stage"}var j=d.stage.elem.style,m;j.width=this.width+"px";j.height=this.height+"px";j.overflow="hidden";j.position="relative";m=d.inner(d.stage.elem);d.stage.x=m.x;d.stage.y=m.y;if(d.support.setter){this.__defineSetter__("x",function(n){this.scroll("_x",n)});this.__defineSetter__("y",function(n){this.scroll("_y",n)});this.__defineGetter__("x",function(){return this._x});this.__defineGetter__("y",function(){return this._y})}else{this.x=this._x;this.y=this._y;d.e("viewport")}}},support:{},keys:{BSP:8,TAB:9,ENT:13,SHF:16,CTR:17,ALT:18,PAU:19,CAP:20,ESC:27,SP:32,PGU:33,PGD:34,END:35,HOM:36,LA:37,UA:38,RA:39,DA:40,INS:45,DEL:46,D0:48,D1:49,D2:50,D3:51,D4:52,D5:53,D6:54,D7:55,D8:56,D9:57,SEM:59,EQL:61,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,LWN:91,RWN:92,SEL:93,N0:96,N1:97,N2:98,N3:99,N4:100,N5:101,N6:102,N7:103,N8:104,N9:105,MUL:106,ADD:107,SUB:109,DEC:110,DIV:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM:144,SCR:145,COM:188,PER:190,FSL:191,ACC:192,OBR:219,BSL:220,CBR:221,QOT:222}});d.onload(this,function(){d.support.setter=("__defineSetter__" in this&&"__defineGetter__" in this);d.support.audio=("Audio" in c)});d.c("viewport",{init:function(){this.bind("enterframe",function(){if(d.viewport._x!==d.viewport.x){d.viewport.scroll("_x",d.viewport.x)}if(d.viewport._y!==d.viewport.y){d.viewport.scroll("_y",d.viewport.y)}})}});var b={add:function f(i,e){this.redraw(i,e);this.redraw(i)},redraw:function h(A,m){var B,D=0,C=0,o,p,u,r,G,H=0,F=false,e={},k=[];if(!m){F=true}m=m||A;B=d.map.search({x:m._x,y:m._y,w:m._w,h:m._h},false);for(D=0;D<B.length;++D){u=B[D];if(u.isCanvas&&!e[u[0]]&&u._x<m._x+m._w&&u._x+u._w>m._x&&u._y<m._y+m._h&&u._h+u._y>m._y){e[u[0]]=true;if(u===A&&!F){continue}if(!k[u._z]){k[u._z]=[]}k[u._z].push(u);++H}}if(H==0){return}if(H==1&&F){A.draw();return}for(D=0,o=k.length;D<o;++D){if(!k[D]){continue}G=k[D];p=G.length;for(C=0;C<p;++C){var n=G[C];if(n[0]!==A[0]){var t=(m._x-n._x<=0)?0:(m._x-n._x),s=Math.ceil(m._y-n._y<0?0:(m._y-n._y)),v=Math.min(n._w-t,m._w-(n._x-m._x),m._w),E=Math.ceil(Math.min(n._h-s,m._h-(n._y-m._y),m._h));if(E===0||v===0){continue}n.draw(t,s,v,E)}else{n.draw()}}}},remove:function(e){this.redraw(e,e)}};d.c("canvas",{isCanvas:true,buffer:50,init:function(){this.bind("change",function(i){i=i||this;d.context.clearRect(i._x,i._y,i._w,i._h);if((i._x+i._w>0-this.buffer&&i._y+i._h>0-this.buffer&&i._x<d.viewport.width+this.buffer&&i._y<d.viewport.height+this.buffer)||(this._x+this._w>0-this.buffer&&this._y+this._h>0-this.buffer&&this._x<d.viewport.width+this.buffer&&this._y<d.viewport.height+this.buffer)){b.add(this,i)}});this.bind("remove",function(){d.context.clearRect(this._x,this._y,this._w,this._h);b.remove(this)})},draw:function(e,o,i,j){var k={},n={_x:Math.floor(this._x),_y:Math.floor(this._y),_w:Math.floor(this._w),_h:Math.floor(this._h)},m=this.__coord||[];k.x=m[0];k.y=m[1];k.w=m[2];k.h=m[3];if(e!==undefined){k.x=m[0]+e;n._x+=e;if(o!==undefined){k.y=m[1]+o;n._y+=o}if(i!==undefined){k.w=i;n._w=i}if(j!==undefined){k.h=j;n._h=j}}if(this._mbr){d.context.save();d.context.translate(this._origin.x+this._x,this._origin.y+this._y);n._x=-this._origin.x;n._y=-this._origin.y;d.context.rotate((this._rotation%360)*(Math.PI/180))}this.trigger("draw",{type:"canvas",spritePos:k,pos:n});if(this.__c.sprite){if(!this.img.width){return}d.context.drawImage(this.img,k.x,k.y,k.w,k.h,n._x,n._y,n._w,n._h)}if(this._mbr){d.context.restore()}return this}});d.extend({context:null,_canvas:null,gz:0,canvas:function(e){if(typeof e==="string"){e=a.getElementById(e)}else{if(!e){e=a.createElement("canvas");this.stage.elem.appendChild(e)}}if(!("getContext" in e)){d.trigger("nocanvas");return}this.context=e.getContext("2d");this._canvas=e;this._canvas.width=this.viewport.width;this._canvas.height=this.viewport.height}});d.extend({down:null,over:null,mouseDispatch:function(o){var r=-1,k,j,n=0,m;j=d.map.search(d.viewport.rect());for(m=j.length;n<m;++n){if(!j[n].has("mouse")){continue}var p=j[n],s=false,u=o.clientX-d.stage.x,t=o.clientY-d.stage.y;if(p.map){if(p.map.containsPoint(u,t)){s=true}}else{if(p.isAt(u,t)){s=true}}if(s&&(p._z>=r||r===-1)){if(p._z===r&&p[0]<k[0]){continue}r=p._z;k=p}}if(k){if(o.type==="mousedown"){this.down=k}if(o.type==="mouseup"){if(this.down&&k===this.down){this.down.trigger("click",o);this.down=null;return}this.down=null}if(o.type==="mousemove"){if(this.over!==k){if(this.over){this.over.trigger("mouseout",o);this.over=null}this.over=k;k.trigger("mouseover",o);return}}k.trigger(o.type,o)}else{if(o.type==="mousemove"&&this.over){this.over.trigger("mouseout",o);this.over=null}}}});d.onload(this,function(){d.addEvent(this,d.stage.elem,"mousedown",d.mouseDispatch);d.addEvent(this,d.stage.elem,"mouseup",d.mouseDispatch);d.addEvent(this,d.stage.elem,"mousemove",d.mouseDispatch)});d.c("mouse",{areaMap:function(m){if(arguments.length>1){var j=Array.prototype.slice.call(arguments,0),k=0,e=j.length;for(;k<e;k++){j[k][0]+=this.x;j[k][1]+=this.y}m=new d.polygon(j)}this.map=m;this.attach(this.map);return this}});d.c("controls",{init:function(){function e(i){this.trigger(i.type,i)}d.addEvent(this,"keydown",e);d.addEvent(this,"keyup",e);this.bind("remove",function(){d.removeEvent(this,"keydown",e);d.removeEvent(this,"keyup",e)})},preventTypeaheadFind:function(i){if(!(i.metaKey||i.altKey||i.shiftKey||i.ctrlKey)&&i.preventDefault){i.preventDefault()}return this}});d.c("fourway",{__move:{left:false,right:false,up:false,down:false},_speed:3,init:function(){if(!this.has("controls")){this.addComponent("controls")}},fourway:function(i){if(i){this._speed=i}var e=this.__move;this.bind("enterframe",function(){var j=this.pos(),k=false;if(e.right){this.x+=this._speed;k=true}if(e.left){this.x-=this._speed;k=true}if(e.up){this.y-=this._speed;k=true}if(e.down){this.y+=this._speed;k=true}}).bind("keydown",function(j){if(j.keyCode===d.keys.RA||j.keyCode===d.keys.D){e.right=true}if(j.keyCode===d.keys.LA||j.keyCode===d.keys.A){e.left=true}if(j.keyCode===d.keys.UA||j.keyCode===d.keys.W){e.up=true}if(j.keyCode===d.keys.DA||j.keyCode===d.keys.S){e.down=true}this.preventTypeaheadFind(j)}).bind("keyup",function(j){if(j.keyCode===d.keys.RA||j.keyCode===d.keys.D){e.right=false}if(j.keyCode===d.keys.LA||j.keyCode===d.keys.A){e.left=false}if(j.keyCode===d.keys.UA||j.keyCode===d.keys.W){e.up=false}if(j.keyCode===d.keys.DA||j.keyCode===d.keys.S){e.down=false}this.preventTypeaheadFind(j)});return this}});d.c("twoway",{__move:{left:false,right:false,up:false,falling:false},_speed:3,init:function(){if(!this.has("controls")){this.addComponent("controls")}},twoway:function(j,i){if(j){this._speed=j}i=i||this._speed*2;var e=this.__move;this.bind("enterframe",function(){var k=this.pos(),m=false;if(e.right){this.x+=this._speed;m=true}if(e.left){this.x-=this._speed;m=true}if(e.up){this.y-=i;this._falling=true;m=true}}).bind("keydown",function(k){if(k.keyCode===d.keys.RA||k.keyCode===d.keys.D){e.right=true}if(k.keyCode===d.keys.LA||k.keyCode===d.keys.A){e.left=true}if(k.keyCode===d.keys.UA||k.keyCode===d.keys.W){e.up=true}}).bind("keyup",function(k){if(k.keyCode===d.keys.RA||k.keyCode===d.keys.D){e.right=false}if(k.keyCode===d.keys.LA||k.keyCode===d.keys.A){e.left=false}});return this}});d.c("animate",{_reels:{},_frame:null,_current:null,animate:function(e,m,r,n){if(arguments.length===2&&typeof m==="number"){this._current=e;var k=this._reels[e],j=m;this._frame={reel:k,frameTime:Math.ceil(j/k.length),frame:0,current:0};this.bind("enterframe",this.drawFrame);return this}if(typeof m==="number"){var q=n+1-m,o=m,k=[],p=this.__tile;for(;o<=n;o++){k.push([o*p,r*p])}this._reels[e]=k}else{if(typeof m==="object"){this._reels[e]=m}}return this},drawFrame:function(j){var i=this._frame;if(this._frame.current++===i.frameTime){var k=i.reel[i.frame++];this.__coord[0]=k[0];this.__coord[1]=k[1];this._frame.current=0}if(i.frame===i.reel.length&&this._frame.current===i.frameTime){i.frame=0;this.stop();return}this.trigger("change")},stop:function(){this.unbind("enterframe",this.drawFrame);this._current=null;this._frame=null;return this},isPlaying:function(e){if(!e){return !!this._interval}return this._current===e}});d.c("color",{_color:"",init:function(){this.bind("draw",function(i){if(i.type==="DOM"){i.style.background=this._color;i.style.lineHeight=0}else{if(i.type==="canvas"){if(this._color){d.context.fillStyle=this._color}d.context.fillRect(i.pos._x,i.pos._y,i.pos._w,i.pos._h)}}})},color:function(e){this._color=e;this.trigger("change");return this}});d.c("image",{_repeat:"repeat",init:function(){this.bind("draw",function(i){if(i.type==="canvas"){this.canvasDraw(i)}else{if(i.type==="DOM"){if(this.__image){i.style.background="url("+this.__image+") "+this._repeat}}}})},image:function(i,j){this.__image=i;this._repeat=j||"repeat";if(this.has("canvas")){this.img=new Image();this.img.src=i;var e=this;this.img.onload=function(){b.add(e)}}else{this.trigger("change")}return this},canvasDraw:function(t){if(!this.img){return}var r=0,n,p,o,q=t.pos||this,s=this._w%this.img.width||this.img.width,v=this._h%this.img.height||this.img.height,m=this._w<this.img.width?s:this.img.width,u=this._h<this.img.height?v:this.img.height;if(this._repeat==="no-repeat"){d.context.drawImage(this.img,0,0,m,u,q._x,q._y,m,u)}else{if(this._repeat==="repeat-x"){for(n=Math.ceil(this._w/this.img.width);r<n;r++){if(r===n-1){m=s}d.context.drawImage(this.img,0,0,m,u,q._x+this.img.width*r,q._y,m,u)}}else{if(this._repeat==="repeat-y"){for(n=Math.ceil(this._h/this.img.height);r<n;r++){if(r===n-1){u=v}d.context.drawImage(this.img,0,0,m,u,q._x,q._y+this.img.height*r,m,u)}}else{for(n=Math.ceil(this._w/this.img.width);r<n;r++){if(r===n-1){m=s}d.context.drawImage(this.img,0,0,m,u,q._x+this.img.width*r,q._y,m,u);u=this._h<this.img.height?v:this.img.height;for(p=0,o=Math.ceil(this._h/this.img.height);p<o;p++){if(p===o-1){u=v}d.context.drawImage(this.img,0,0,m,u,q._x+this.img.width*r,q._y+this.img.height*p,m,u)}}}}}}});d.extend({_scenes:[],_current:null,scene:function(e,i){if(arguments.length===1){d("2D").destroy();this._scenes[e].call(this);this._current=e;return}this._scenes[e]=i;return}});d.c("group",{_children:[],group:function(e){this._children=e;this.bind("move",function(r){var m=r._x-this.x,k=r._y-this.y,n=r._w-this.w,p=r._h-this.h,o=0,j=this._children.length,q;for(;o<j;o++){q=this._children[o];if(m){q.x-=m}if(k){q.y-=k}if(n){q.w-=n}if(p){q.h-=p}}});this.bind("remove",function(){var k=0,j=this._children.length,m;for(;k<j;k++){m.destroy()}});return this}});d.extend({group:function(){var r=d.e("2D, group"),p=Array.prototype.slice.call(arguments),n=0,k=p.length,m,e,j,q,o;for(;n<k;n++){o=p[n];o.removeComponent("obj");if(o.x<m||!m){m=o.x}if(o.x+o.w>m+e||!e){e=o.x+o.w-m}if(o.y<j||!j){j=o.y}if(o.y+o.h<j+q||!q){q=o.y+o.h-j}}r.attr({x:m,y:j,w:e,h:q}).group(p);return r}});d.extend({isometric:{_tile:0,_z:0,init:function(e){this._tile=e;return this},place:function(i,p,k,j){var e=i*this._tile+(p&1)*(this._tile/2),o=p*this._tile/4,o=o-k*(this._tile/2);j.attr({x:e+d.viewport._x,y:o+d.viewport._y}).z+=k;return this},zoom:function(e){this._tile=e;d.trigger("zoom",{tile:e});return this}}});d.extend({audio:{_elems:{},type:{mp3:"audio/mpeg;",ogg:'audio/ogg; codecs="vorbis"',wav:'audio/wav; codecs="1"',mp4:'audio/mp4; codecs="mp4a.40.2"'},add:function(m,k){if(!d.support.audio){return}var o,s,q=new Audio(),n;if(arguments.length===1&&typeof m==="object"){for(s in m){if(!m.hasOwnProperty(s)){continue}if(typeof m[s]!=="string"){var j=m[s],r=0,p=j.length,e;for(;r<p;++r){e=j[r];ext=e.substr(e.lastIndexOf(".")+1);n=q.canPlayType(this.type[ext]);if(n!==""&&n!=="no"){k=e;break}}}else{k=m[s]}this._elems[s]=d.assets[k];if(!this._elems[s]){this._elems[s]=new Audio(k);d.assets[k]=this._elems[s]}this._elems[s].preload="auto";this._elems[s].load()}return this}if(typeof k!=="string"){var r=0,p=k.length,e;for(;r<p;++r){e=k[r];ext=e.substr(e.lastIndexOf(".")+1);n=q.canPlayType(this.type[ext]);if(n!==""&&n!=="no"){k=e;break}}}this._elems[s]=d.assets[k];if(!this._elems[s]){this._elems[s]=new Audio(k);d.assets[k]=this._elems[s]}this._elems[m].preload="auto";this._elems[m].load();return this},play:function(i){if(!d.support.audio){return}var e=this._elems[i];if(e.ended||!e.currentTime){e.play()}return this},settings:function(m,j){if(!j){for(var e in this._elems){this.settings(e,m)}return this}var k=this._elems[m];for(var i in j){k[i]=j[i]}return this}}});d.c("text",{_text:"",_font:"",init:function(){this.bind("draw",function(k){if(k.type==="DOM"){var j=this._element,i=j.style;j.innerHTML=this._text;i.font=this._font}else{}})},text:function(e){if(!e){return this._text}this._text=e;this.trigger("change");return this},font:function(e){this._font=e;this.trigger("change");return this}});d.c("health",{_mana:100,health:function(e){this._mana=e;return this},hurt:function(e){this._mana-=e;this.trigger("hurt",{by:e,mana:this._mana});if(this._mana<=0){this.trigger("die")}return this},heal:function(e){this._mana+=e;this.trigger("heal");return this}});d.c("score",{_score:0,incrementScore:function(e){this._score+=e;return this},decrementScore:function(e){this._score-=e;return this}});d.extend({assets:{},load:function(o,r){var m=0,e=o.length,q,p,n=e,k=0;for(;m<e;++m){q=o[m];ext=q.substr(q.lastIndexOf(".")+1).toLowerCase();if((ext==="mp3"||ext==="wav"||ext==="ogg"||ext==="mp4")&&d.support.audio){p=new Audio(q)}else{if(ext==="jpg"||ext==="jpeg"||ext==="gif"||ext==="png"){p=new Image();p.src=q}else{n--;continue}}this.assets[q]=p;p.onload=function(){++k;if(k===n){if(r){r()}}}}}})})(Crafty,window,window.document);